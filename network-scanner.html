<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ネットワークスキャナー - LocalNetworkAccessRestrictionsEnabled テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .scanner-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        input,
        select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 8px;
            color: white;
            margin: 5px;
            width: 100%;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .result-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .scan-result {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid;
        }

        .result-success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
        }

        .result-blocked {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }

        .result-timeout {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }

        .result-error {
            background: rgba(156, 39, 176, 0.2);
            border-color: #9c27b0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c9ff 0%, #92fe9d 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .policy-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
        }

        .policy-enabled {
            background: #d32f2f;
            color: white;
        }

        .policy-disabled {
            background: #388e3c;
            color: white;
        }

        .policy-unknown {
            background: #f57c00;
            color: white;
        }

        .scanning {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="policyIndicator" class="policy-indicator policy-unknown">
        🔍 ポリシー状態確認中...
    </div>

    <div class="container">
        <h1>🔍 ネットワークスキャナー</h1>
        <p style="text-align: center; opacity: 0.9;">LocalNetworkAccessRestrictionsEnabled ポリシーの高度な動作検証ツール</p>

        <div class="scanner-section">
            <h2>🎛️ スキャン設定</h2>

            <div class="control-panel">
                <div class="control-group">
                    <h3>📡 スキャン範囲</h3>
                    <select id="scanMode">
                        <option value="quick">クイックスキャン</option>
                        <option value="full">フルスキャン</option>
                        <option value="custom">カスタム範囲</option>
                        <option value="ports">ポートスキャン</option>
                    </select>
                    <input type="text" id="customRange" placeholder="例: 192.168.1.1-10" style="display: none;">
                    <input type="text" id="portRange" placeholder="例: 80,8080,3000-3010" style="display: none;">
                </div>

                <div class="control-group">
                    <h3>⚙️ 実行オプション</h3>
                    <label><input type="checkbox" id="aggressiveMode"> アグレッシブモード</label><br>
                    <label><input type="checkbox" id="timeoutShort"> 短縮タイムアウト</label><br>
                    <label><input type="checkbox" id="includeHttps"> HTTPS含む</label>
                </div>

                <div class="control-group">
                    <h3>🎯 並行度設定</h3>
                    <label>同時接続数: <span id="concurrencyValue">5</span></label>
                    <input type="range" id="concurrency" min="1" max="20" value="5">
                    <label>要求間隔: <span id="delayValue">100</span>ms</label>
                    <input type="range" id="delay" min="0" max="1000" value="100" step="50">
                </div>

                <div class="control-group">
                    <h3>🚀 実行制御</h3>
                    <button onclick="startScan()" id="startBtn">スキャン開始</button>
                    <button onclick="stopScan()" id="stopBtn" disabled>スキャン停止</button>
                    <button onclick="clearResults()">結果クリア</button>
                    <button onclick="exportResults()">結果エクスポート</button>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="totalScanned">0</span>
                    <span class="stat-label">スキャン済み</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="successCount">0</span>
                    <span class="stat-label">成功</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="blockedCount">0</span>
                    <span class="stat-label">ブロック</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="timeoutCount">0</span>
                    <span class="stat-label">タイムアウト</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="errorCount">0</span>
                    <span class="stat-label">エラー</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="avgResponseTime">0</span>
                    <span class="stat-label">平均応答(ms)</span>
                </div>
            </div>
        </div>

        <div class="results-container">
            <div class="result-panel">
                <h3>📊 リアルタイム結果</h3>
                <div id="liveResults"></div>
            </div>

            <div class="result-panel">
                <h3>📈 詳細ログ</h3>
                <div id="detailedLog"></div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let scanActive = false;
        let scanAborted = false;
        let scanResults = [];
        let scanStats = {
            total: 0,
            success: 0,
            blocked: 0,
            timeout: 0,
            error: 0,
            totalResponseTime: 0
        };

        // UI初期化
        document.addEventListener('DOMContentLoaded', function () {
            initializeUI();
            checkPolicyStatus();
        });

        function initializeUI() {
            // スライダーの値表示更新
            document.getElementById('concurrency').addEventListener('input', function () {
                document.getElementById('concurrencyValue').textContent = this.value;
            });

            document.getElementById('delay').addEventListener('input', function () {
                document.getElementById('delayValue').textContent = this.value;
            });

            // スキャンモード変更時のUI更新
            document.getElementById('scanMode').addEventListener('change', function () {
                const customRange = document.getElementById('customRange');
                const portRange = document.getElementById('portRange');

                if (this.value === 'custom') {
                    customRange.style.display = 'block';
                    portRange.style.display = 'none';
                } else if (this.value === 'ports') {
                    customRange.style.display = 'none';
                    portRange.style.display = 'block';
                } else {
                    customRange.style.display = 'none';
                    portRange.style.display = 'none';
                }
            });
        }

        // ポリシー状態確認
        async function checkPolicyStatus() {
            const indicator = document.getElementById('policyIndicator');

            try {
                // 簡易ポリシーテスト
                const testResult = await quickPolicyTest();

                if (testResult.likely_enabled) {
                    indicator.textContent = '🔒 ポリシー: 有効 (推測)';
                    indicator.className = 'policy-indicator policy-enabled';
                } else {
                    indicator.textContent = '🔓 ポリシー: 無効 (推測)';
                    indicator.className = 'policy-indicator policy-disabled';
                }
            } catch (error) {
                indicator.textContent = '❓ ポリシー: 不明';
                indicator.className = 'policy-indicator policy-unknown';
            }
        }

        // 簡易ポリシーテスト
        async function quickPolicyTest() {
            const testUrls = [
                'http://192.168.1.1:80',
                'http://10.0.0.1:80',
                'http://172.16.0.1:80'
            ];

            let blockedCount = 0;
            let fastFailures = 0;

            for (const url of testUrls) {
                const startTime = Date.now();
                try {
                    await fetch(url, {
                        method: 'GET',
                        mode: 'no-cors',
                        signal: AbortSignal.timeout(2000)
                    });
                } catch (error) {
                    const responseTime = Date.now() - startTime;
                    if (responseTime < 100) {
                        fastFailures++;
                    }
                    blockedCount++;
                }
            }

            return {
                likely_enabled: fastFailures >= 2,
                blocked_ratio: blockedCount / testUrls.length
            };
        }

        // スキャン開始
        async function startScan() {
            if (scanActive) return;

            scanActive = true;
            scanAborted = false;
            scanResults = [];
            resetStats();

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            startBtn.disabled = true;
            stopBtn.disabled = false;
            startBtn.classList.add('scanning');

            logMessage('🚀 スキャンを開始しています...', 'info');

            try {
                const targets = await generateScanTargets();
                await executeScan(targets);

                if (!scanAborted) {
                    logMessage('✅ スキャンが完了しました。', 'success');
                }
            } catch (error) {
                logMessage(`❌ スキャンエラー: ${error.message}`, 'error');
            } finally {
                scanActive = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                startBtn.classList.remove('scanning');
                updateProgress(100);
            }
        }

        // スキャン停止
        function stopScan() {
            scanAborted = true;
            logMessage('⏹️ スキャンを停止しています...', 'warning');
        }

        // スキャン対象生成
        async function generateScanTargets() {
            const mode = document.getElementById('scanMode').value;
            const includeHttps = document.getElementById('includeHttps').checked;
            const targets = [];

            switch (mode) {
                case 'quick':
                    targets.push(...getQuickScanTargets());
                    break;
                case 'full':
                    targets.push(...getFullScanTargets());
                    break;
                case 'custom':
                    targets.push(...getCustomRangeTargets());
                    break;
                case 'ports':
                    targets.push(...getPortScanTargets());
                    break;
            }

            // HTTPS バリアントを追加
            if (includeHttps) {
                const httpsTargets = targets.map(target =>
                    target.replace('http://', 'https://')
                );
                targets.push(...httpsTargets);
            }

            return [...new Set(targets)]; // 重複削除
        }

        function getQuickScanTargets() {
            return [
                'http://localhost:8080',
                'http://127.0.0.1:8080',
                'http://192.168.1.1:80',
                'http://192.168.0.1:80',
                'http://10.0.0.1:80',
                'http://172.16.0.1:80'
            ];
        }

        function getFullScanTargets() {
            const targets = [];
            const commonPorts = [80, 8080, 3000, 5000, 8000, 9090];
            const privateRanges = [
                '192.168.1',
                '192.168.0',
                '10.0.0',
                '172.16.0'
            ];

            // プライベートIP範囲の組み合わせ
            for (const range of privateRanges) {
                for (let i = 1; i <= 10; i++) {
                    for (const port of commonPorts) {
                        targets.push(`http://${range}.${i}:${port}`);
                    }
                }
            }

            return targets;
        }

        function getCustomRangeTargets() {
            const range = document.getElementById('customRange').value;
            // カスタム範囲の解析とターゲット生成
            // 簡易実装
            return [`http://${range}:80`];
        }

        function getPortScanTargets() {
            const portRange = document.getElementById('portRange').value;
            const baseIP = '192.168.1.1';
            const targets = [];

            if (portRange) {
                const ports = parsePortRange(portRange);
                for (const port of ports) {
                    targets.push(`http://${baseIP}:${port}`);
                }
            }

            return targets;
        }

        function parsePortRange(portRange) {
            const ports = [];
            const parts = portRange.split(',');

            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    for (let port = start; port <= end; port++) {
                        ports.push(port);
                    }
                } else {
                    ports.push(Number(part));
                }
            }

            return ports;
        }

        // スキャン実行
        async function executeScan(targets) {
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const delay = parseInt(document.getElementById('delay').value);
            const aggressiveMode = document.getElementById('aggressiveMode').checked;
            const timeoutShort = document.getElementById('timeoutShort').checked;

            const timeout = timeoutShort ? 2000 : 5000;
            let completedCount = 0;

            // 並行実行の管理
            const semaphore = new Semaphore(concurrency);
            const promises = targets.map(async (target, index) => {
                await semaphore.acquire();

                try {
                    if (scanAborted) return;

                    if (delay > 0 && index > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }

                    const result = await scanTarget(target, timeout, aggressiveMode);

                    completedCount++;
                    updateProgress((completedCount / targets.length) * 100);
                    updateStats(result);
                    displayResult(result);

                } finally {
                    semaphore.release();
                }
            });

            await Promise.all(promises);
        }

        // 個別ターゲットスキャン
        async function scanTarget(url, timeout, aggressive) {
            const startTime = Date.now();
            const result = {
                url: url,
                timestamp: new Date().toISOString(),
                success: false,
                blocked: false,
                timeout: false,
                error: false,
                responseTime: 0,
                status: null,
                errorMessage: null
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                const response = await fetch(url, {
                    method: aggressive ? 'POST' : 'GET',
                    mode: 'no-cors',
                    signal: controller.signal,
                    headers: aggressive ? {
                        'Content-Type': 'application/json',
                        'X-Test-Header': 'LocalNetworkAccessTest'
                    } : {}
                });

                clearTimeout(timeoutId);
                result.responseTime = Date.now() - startTime;
                result.success = true;
                result.status = response.status;

            } catch (error) {
                result.responseTime = Date.now() - startTime;

                if (error.name === 'AbortError') {
                    result.timeout = true;
                } else if (error.message.includes('Failed to fetch') ||
                    error.message.includes('Network request failed')) {
                    result.blocked = true;
                } else {
                    result.error = true;
                    result.errorMessage = error.message;
                }
            }

            scanResults.push(result);
            return result;
        }

        // セマフォクラス（並行制御）
        class Semaphore {
            constructor(max) {
                this.max = max;
                this.current = 0;
                this.queue = [];
            }

            async acquire() {
                return new Promise(resolve => {
                    if (this.current < this.max) {
                        this.current++;
                        resolve();
                    } else {
                        this.queue.push(resolve);
                    }
                });
            }

            release() {
                this.current--;
                if (this.queue.length > 0) {
                    this.current++;
                    const resolve = this.queue.shift();
                    resolve();
                }
            }
        }

        // 統計更新
        function updateStats(result) {
            scanStats.total++;
            scanStats.totalResponseTime += result.responseTime;

            if (result.success) scanStats.success++;
            else if (result.blocked) scanStats.blocked++;
            else if (result.timeout) scanStats.timeout++;
            else if (result.error) scanStats.error++;

            // UI更新
            document.getElementById('totalScanned').textContent = scanStats.total;
            document.getElementById('successCount').textContent = scanStats.success;
            document.getElementById('blockedCount').textContent = scanStats.blocked;
            document.getElementById('timeoutCount').textContent = scanStats.timeout;
            document.getElementById('errorCount').textContent = scanStats.error;

            const avgResponseTime = scanStats.total > 0 ?
                Math.round(scanStats.totalResponseTime / scanStats.total) : 0;
            document.getElementById('avgResponseTime').textContent = avgResponseTime;
        }

        // 統計リセット
        function resetStats() {
            scanStats = {
                total: 0,
                success: 0,
                blocked: 0,
                timeout: 0,
                error: 0,
                totalResponseTime: 0
            };
            updateStats({ responseTime: 0, success: false, blocked: false, timeout: false, error: false });
        }

        // 進捗更新
        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        // 結果表示
        function displayResult(result) {
            const liveResults = document.getElementById('liveResults');
            const resultDiv = document.createElement('div');

            let className, icon, status;
            if (result.success) {
                className = 'result-success';
                icon = '✅';
                status = 'SUCCESS';
            } else if (result.blocked) {
                className = 'result-blocked';
                icon = '🚫';
                status = 'BLOCKED';
            } else if (result.timeout) {
                className = 'result-timeout';
                icon = '⏱️';
                status = 'TIMEOUT';
            } else {
                className = 'result-error';
                icon = '❌';
                status = 'ERROR';
            }

            resultDiv.className = `scan-result ${className}`;
            resultDiv.innerHTML = `
                ${icon} ${status} | ${result.url} | ${result.responseTime}ms
                ${result.errorMessage ? `<br>Error: ${result.errorMessage}` : ''}
            `;

            liveResults.insertBefore(resultDiv, liveResults.firstChild);

            // 最大表示数制限
            while (liveResults.children.length > 100) {
                liveResults.removeChild(liveResults.lastChild);
            }
        }

        // ログメッセージ表示
        function logMessage(message, type) {
            const detailedLog = document.getElementById('detailedLog');
            const logDiv = document.createElement('div');

            const timestamp = new Date().toLocaleTimeString();
            logDiv.className = `scan-result result-${type}`;
            logDiv.textContent = `[${timestamp}] ${message}`;

            detailedLog.insertBefore(logDiv, detailedLog.firstChild);

            // ログ制限
            while (detailedLog.children.length > 50) {
                detailedLog.removeChild(detailedLog.lastChild);
            }
        }

        // 結果クリア
        function clearResults() {
            document.getElementById('liveResults').innerHTML = '';
            document.getElementById('detailedLog').innerHTML = '';
            scanResults = [];
            resetStats();
            updateProgress(0);
            logMessage('🧹 結果をクリアしました。', 'info');
        }

        // 結果エクスポート
        function exportResults() {
            if (scanResults.length === 0) {
                alert('エクスポートする結果がありません。');
                return;
            }

            const data = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    total_scanned: scanStats.total,
                    summary: {
                        success: scanStats.success,
                        blocked: scanStats.blocked,
                        timeout: scanStats.timeout,
                        error: scanStats.error
                    }
                },
                results: scanResults
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network-scan-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logMessage('📊 結果をエクスポートしました。', 'success');
        }
    </script>
</body>

</html>